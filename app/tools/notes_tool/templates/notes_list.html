{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>My {{ type_name }}</h1>
    <div>
        <a href="/tools/notes" class="btn btn-secondary me-2">Back to Dashboard</a>
        <button class="btn btn-primary" onclick="createNew('{{ type }}')">+ New {{ type_name[:-1] }}</button>
    </div>
</div>

<div class="row" id="notes-list">
    {% for note in notes %}
    <div class="col-md-4 mb-3">
        <div class="card h-100 hover-shadow" onclick="window.location.href='/tools/notes/edit/{{ type }}/{{ note.id }}'"
            style="cursor: pointer;">
            <div class="card-body">
                <h5 class="card-title">{{ note.title|default('Untitled') }}</h5>
                <p class="card-text text-muted small">
                    {% if type == 'todo' %}
                    <span class="d-block mb-1">
                        {{ note.item_count }} items
                        {% if note.deadline %}
                        <span class="badge deadline-badge ms-2" data-deadline="{{ note.deadline }}"
                            data-completed="{{ 'true' if note.all_completed else 'false' }}">
                            Due: {{ note.deadline }} - <span class="deadline-status">Pending</span>
                        </span>
                        {% endif %}
                    </span>
                    {% endif %}
                    <span class="last-modified" data-timestamp="{{ note.updated_at }}">
                        Last modified: Just now
                    </span>
                </p>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12 text-center py-5">
        <p class="lead text-muted">No {{ type_name|lower }} found.</p>
        <button class="btn btn-outline-primary" onclick="createNew('{{ type }}')">Create your first {{ type_name[:-1]
            }}</button>
    </div>
    {% endfor %}
</div>

<script>
    async function createNew(type) {
        try {
            const response = await fetch('/tools/notes/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ note_type: type })
            });

            if (response.ok) {
                const note = await response.json();
                window.location.href = `/tools/notes/edit/${type}/${note.id}`;
            }
        } catch (error) {
            console.error('Error creating note:', error);
        }
    }

    function timeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " years ago";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " months ago";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " days ago";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " hours ago";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " minutes ago";
        return "Just now";
    }

    function formatDates() {
        document.querySelectorAll('.last-modified').forEach(el => {
            const timestamp = el.getAttribute('data-timestamp');
            if (timestamp) {
                const date = new Date(timestamp);
                const localDate = date.toLocaleString(undefined, {
                    year: 'numeric', month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                const relative = timeAgo(date);
                el.innerText = `Last modified: ${localDate} (${relative})`;
            }
        });
    }

    function updateDeadlineColors() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        document.querySelectorAll('.deadline-badge').forEach(el => {
            const deadlineStr = el.getAttribute('data-deadline');
            const isCompleted = el.getAttribute('data-completed') === 'true';
            const statusSpan = el.querySelector('.deadline-status');

            if (!deadlineStr) return;

            const deadline = new Date(deadlineStr);
            // Reset time to end of day for fair comparison (deadline is usually end of that day)
            deadline.setHours(23, 59, 59, 999);

            el.classList.remove('bg-warning', 'bg-danger', 'bg-success', 'bg-purple', 'text-dark');
            el.classList.add('text-white'); // Default text color

            if (isCompleted) {
                if (deadline < today) {
                    el.classList.add('bg-purple');
                    statusSpan.textContent = "Completed Late";
                } else {
                    el.classList.add('bg-success');
                    statusSpan.textContent = "Completed";
                }
            } else if (deadline < today) {
                el.classList.add('bg-danger');
                statusSpan.textContent = "Overdue";
            } else {
                el.classList.add('bg-warning', 'text-dark'); // Yellow needs dark text
                el.classList.remove('text-white');
                statusSpan.textContent = "Pending";
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        formatDates();
        updateDeadlineColors();
    });
</script>

<style>
    .hover-shadow:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    .bg-purple {
        background-color: #6f42c1 !important;
        color: white !important;
    }
</style>
{% endblock %}